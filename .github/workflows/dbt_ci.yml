name: DBT CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  dbt-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: warehouse
          POSTGRES_PASSWORD: warehouse
          POSTGRES_DB: gaming_dwh
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install dbt-core==1.7.4 dbt-postgres==1.7.4

      - name: Setup DBT profiles
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << PROF
          gaming_dbt:
            outputs:
              ci:
                type: postgres
                host: localhost
                port: 5432
                user: warehouse
                password: warehouse
                dbname: gaming_dwh
                schema: ci_test
                threads: 4
            target: ci
          PROF

      - name: Create database schemas
        run: |
          PGPASSWORD=warehouse psql -h localhost -U warehouse -d gaming_dwh -c "
          CREATE SCHEMA IF NOT EXISTS bronze;
          CREATE SCHEMA IF NOT EXISTS silver;
          CREATE SCHEMA IF NOT EXISTS gold;
          CREATE SCHEMA IF NOT EXISTS ci_test;
          "

      - name: DBT Debug
        working-directory: ./dbt_project/gaming_dbt
        run: dbt debug

      - name: Install DBT packages
        working-directory: ./dbt_project/gaming_dbt
        run: dbt deps

      - name: DBT Run (dry run on CI)
        working-directory: ./dbt_project/gaming_dbt
        run: dbt run --target ci
        continue-on-error: true

      - name: DBT Test
        working-directory: ./dbt_project/gaming_dbt
        run: dbt test --target ci
        continue-on-error: true

      - name: Generate DBT Docs
        working-directory: ./dbt_project/gaming_dbt
        run: dbt docs generate
